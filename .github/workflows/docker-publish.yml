name: Build and Push Docker Image

on:
  push:
    branches: [main, master]
    tags: ['v*']
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      platforms:
        description: '选择构建架构'
        type: choice
        required: true
        default: 'arm64'
        options: [arm64, amd64, all]
      push_registry:
        description: '推送到阿里云镜像仓库'
        type: boolean
        required: false
        default: false
      generate_offline:
        description: '生成离线tar包'
        type: boolean
        required: false
        default: true
      tag:
        description: '自定义镜像标签（可选）'
        type: string
        required: false
        default: ''
      dry_run:
        description: '仅构建镜像，不推送或生成制品'
        type: boolean
        required: false
        default: false

concurrency:
  group: docker-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: registry.cn-hangzhou.aliyuncs.com
  # secrets 在 PR(fork) 场景可能为空，给个兜底
  IMAGE_NAME: ${{ secrets.ALIYUN_REPOSITORY_NAME || 'printer_server' }}
  GHCR_REGISTRY: ghcr.io
  GITHUB_REPOSITORY: ${{ github.repository }}

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      platforms_list: ${{ steps.platforms.outputs.platforms_list }}
      tag_name: ${{ steps.tag.outputs.tag_name }}
      tag_from_input: ${{ steps.tag.outputs.tag_from_input }}
      build_date: ${{ steps.builddate.outputs.build_date }}
    steps:
      - uses: actions/checkout@v4

      - name: Set build date
        id: builddate
        run: |
          echo "build_date=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> "$GITHUB_OUTPUT"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Determine tag name
        id: tag
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.tag }}" != "" ]]; then
            echo "tag_name=${{ github.event.inputs.tag }}" >> "$GITHUB_OUTPUT"
            echo "tag_from_input=true" >> "$GITHUB_OUTPUT"
          elif [[ "${{ github.ref_type }}" == "tag" ]]; then
            echo "tag_name=${{ github.ref_name }}" >> "$GITHUB_OUTPUT"
            echo "tag_from_input=false" >> "$GITHUB_OUTPUT"
          else
            echo "tag_name=sha-${{ github.sha }}" >> "$GITHUB_OUTPUT"
            echo "tag_from_input=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Determine platforms
        id: platforms
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            p="${{ github.event.inputs.platforms }}"
            if [[ "$p" == "all" ]]; then
              PLATFORMS="linux/amd64,linux/arm64"
            elif [[ "$p" == "arm64" ]]; then
              PLATFORMS="linux/arm64"
            else
              PLATFORMS="linux/amd64"
            fi
          else
            PLATFORMS="linux/amd64,linux/arm64"
          fi
          echo "platforms_list=$PLATFORMS" >> "$GITHUB_OUTPUT"

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
            ${{ env.GHCR_REGISTRY }}/${{ env.GITHUB_REPOSITORY }}
          flavor: |
            latest=auto
          tags: |
            type=sha,format=short
            type=ref,event=branch
            type=ref,event=tag
            type=raw,value=${{ steps.tag.outputs.tag_name }},enable=true

      - name: Build (no push)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          platforms: ${{ steps.platforms.outputs.platforms_list }}
          push: false
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ env.IMAGE_NAME }}
          cache-to: type=gha,mode=max,scope=${{ env.IMAGE_NAME }}
          build-args: |
            BUILD_DATE=${{ steps.builddate.outputs.build_date }}
            VERSION=${{ steps.tag.outputs.tag_name }}

  push-to-aliyun:
    needs: build
    if: >-
      (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/'))) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.push_registry == 'true' && github.event.inputs.dry_run != 'true')
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Aliyun Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.ALIYUN_REGISTRY_USERNAME }}
          password: ${{ secrets.ALIYUN_REGISTRY_PASSWORD }}

      - name: Extract metadata for Aliyun
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          flavor: |
            latest=auto
          tags: |
            type=sha,format=short
            type=ref,event=branch
            type=ref,event=tag
            type=raw,value=${{ needs.build.outputs.tag_name }},enable=true

      - name: Build and push to Aliyun
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          platforms: ${{ needs.build.outputs.platforms_list }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ env.IMAGE_NAME }}-aliyun
          cache-to: type=gha,mode=max,scope=${{ env.IMAGE_NAME }}-aliyun
          build-args: |
            BUILD_DATE=${{ needs.build.outputs.build_date }}
            VERSION=${{ needs.build.outputs.tag_name }}

  export-offline:
    needs: build
    if: >-
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.generate_offline == 'true' && github.event.inputs.dry_run != 'true')
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 关键：离线 tar 不能对多平台一次 load；这里逐平台构建+save
      - name: Build and export offline tar(s)
        id: offline
        run: |
          set -euo pipefail
          mkdir -p dist

          PLATFORMS="${{ needs.build.outputs.platforms_list }}"
          IFS=',' read -ra arr <<< "$PLATFORMS"

          for p in "${arr[@]}"; do
            arch="${p#linux/}"   # amd64/arm64
            tag="offline:${{ needs.build.outputs.tag_name }}-$arch"

            echo "Building $p -> $tag"
            docker buildx build \
              --platform "$p" \
              --load \
              -t "$tag" \
              --build-arg BUILD_DATE="${{ needs.build.outputs.build_date }}" \
              --build-arg VERSION="${{ needs.build.outputs.tag_name }}" \
              -f Dockerfile .

            out="dist/print-service-${arch}.tar"
            docker save "$tag" -o "$out"
            sha256sum "$out" > "${out}.sha256"
          done

          ls -lah dist

      - name: Upload offline tar artifacts
        uses: actions/upload-artifact@v4
        with:
          name: offline-${{ needs.build.outputs.tag_name }}
          path: dist/*
          compression-level: 1

  create-release:
    needs: [build, push-to-aliyun, export-offline]
    if: >-
      always() &&
      (startsWith(github.ref, 'refs/tags/') ||
       (github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run != 'true'))
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Decide release version
        id: ver
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            echo "version=${{ github.ref_name }}" >> "$GITHUB_OUTPUT"
          else
            echo "version=${{ needs.build.outputs.tag_name }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Download offline artifacts (if any)
        if: needs.export-offline.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: offline-${{ needs.build.outputs.tag_name }}
          path: release/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.ver.outputs.version }}
          name: Release ${{ steps.ver.outputs.version }}
          body: |
            ## Printer Server ${{ steps.ver.outputs.version }}

            ### Docker Images
            - Aliyun: `${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.ver.outputs.version }}`

            ### Offline Packages
            - `print-service-amd64.tar` / `print-service-arm64.tar`
            - `*.sha256`
          files: release/**
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    needs: [build, push-to-aliyun, export-offline]
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - run: |
          echo "Platforms: ${{ needs.build.outputs.platforms_list }}"
          echo "Tag: ${{ needs.build.outputs.tag_name }}"
          echo "Push-to-aliyun: ${{ needs.push-to-aliyun.result }}"
          echo "Offline: ${{ needs.export-offline.result }}"