name: Build and Push Docker Image (Optimized, Prefer ARM64)

on:
  push:
    branches: [main, master]
    tags: ['v*']
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      platforms:
        description: '选择构建架构'
        type: choice
        required: true
        default: 'arm64'
        options: [arm64, amd64, all]
      push_registry:
        description: '推送到阿里云镜像仓库'
        type: boolean
        required: false
        default: false
      generate_offline:
        description: '生成离线tar包'
        type: boolean
        required: false
        default: true
      tag:
        description: '自定义镜像标签（可选）'
        type: string
        required: false
        default: ''
      dry_run:
        description: '仅构建镜像，不推送或生成制品'
        type: boolean
        required: false
        default: false

concurrency:
  group: docker-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: registry.cn-hangzhou.aliyuncs.com
  IMAGE_NAMESPACE: ${{ secrets.ALIYUN_IMAGE_NAMESPACE }}
  IMAGE_NAME: remoteprint
  CACHE_SCOPE: ${{ github.repository }}-remoteprint

jobs:
  docker:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Set build date
        id: builddate
        shell: bash
        run: echo "build_date=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> "$GITHUB_OUTPUT"

      - name: Determine tag name
        id: tag
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ github.event.inputs.tag }}" ]]; then
            echo "tag_name=${{ github.event.inputs.tag }}" >> "$GITHUB_OUTPUT"
          elif [[ "${{ github.ref_type }}" == "tag" ]]; then
            echo "tag_name=${{ github.ref_name }}" >> "$GITHUB_OUTPUT"
          else
            echo "tag_name=sha-${{ github.sha }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Determine platforms (prefer arm64)
        id: platforms
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            p="${{ github.event.inputs.platforms }}"
            if [[ "$p" == "all" ]]; then
              PLATFORMS="linux/arm64,linux/amd64"
            elif [[ "$p" == "amd64" ]]; then
              PLATFORMS="linux/amd64"
            else
              PLATFORMS="linux/arm64"
            fi
          elif [[ "${{ github.ref_type }}" == "tag" ]]; then
            PLATFORMS="linux/arm64,linux/amd64"
          else
            PLATFORMS="linux/arm64"
          fi
          echo "platforms_list=$PLATFORMS" >> "$GITHUB_OUTPUT"

      - name: Decide whether to push
        id: willpush
        shell: bash
        run: |
          WILL_PUSH="false"

          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.push_registry }}" == "true" && "${{ github.event.inputs.dry_run }}" != "true" ]]; then
            WILL_PUSH="true"
          fi

          if [[ "${{ github.event_name }}" == "push" ]]; then
            if [[ "${{ github.ref }}" == "refs/heads/main" || "${{ github.ref }}" == "refs/heads/master" || "${{ github.ref }}" == refs/tags/* ]]; then
              WILL_PUSH="true"
            fi
          fi

          echo "will_push=$WILL_PUSH" >> "$GITHUB_OUTPUT"

      - name: Set up QEMU (only if needed)
        if: contains(steps.platforms.outputs.platforms_list, 'arm64') && runner.arch != 'ARM64'
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Aliyun Container Registry (only when pushing)
        if: steps.willpush.outputs.will_push == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.ALIYUN_REGISTRY_USERNAME }}
          password: ${{ secrets.ALIYUN_REGISTRY_PASSWORD }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ env.IMAGE_NAME }}
          flavor: |
            latest=auto
          tags: |
            type=sha,format=short
            type=ref,event=branch
            type=ref,event=tag
            type=raw,value=${{ steps.tag.outputs.tag_name }},enable=true

      - name: Build (and optionally push)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          platforms: ${{ steps.platforms.outputs.platforms_list }}
          push: ${{ steps.willpush.outputs.will_push == 'true' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ env.CACHE_SCOPE }}
          cache-to: type=gha,mode=max,scope=${{ env.CACHE_SCOPE }}
          provenance: false
          sbom: false
          build-args: |
            BUILD_DATE=${{ steps.builddate.outputs.build_date }}
            VERSION=${{ steps.tag.outputs.tag_name }}

      - name: "Export offline tar(s) (fast path: pull then save)"
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.generate_offline == 'true' && github.event.inputs.dry_run != 'true' && steps.willpush.outputs.will_push == 'true'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist

          TAG="${{ steps.tag.outputs.tag_name }}"
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ env.IMAGE_NAME }}:${TAG}"

          PLATFORMS="${{ steps.platforms.outputs.platforms_list }}"
          IFS=',' read -ra arr <<< "$PLATFORMS"

          ordered=()
          for x in "linux/arm64" "linux/amd64"; do
            for p in "${arr[@]}"; do
              if [[ "$p" == "$x" ]]; then ordered+=("$p"); fi
            done
          done

          for p in "${ordered[@]}"; do
            arch="${p#linux/}"
            echo "Pulling $IMAGE ($p)"
            docker pull --platform "$p" "$IMAGE"

            out="dist/print-service-${arch}.tar"
            docker save "$IMAGE" -o "$out"
            sha256sum "$out" > "${out}.sha256"
          done

          ls -lah dist

      - name: Upload offline tar artifacts
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.generate_offline == 'true' && github.event.inputs.dry_run != 'true' && steps.willpush.outputs.will_push == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: offline-${{ steps.tag.outputs.tag_name }}
          path: dist/*
          compression-level: 1